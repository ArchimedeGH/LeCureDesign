name: Build macOS DMG (Hello App, auto-release)

on:
  workflow_dispatch:  # run manually

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # necessario per creare/pushare il tag

      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      # Build in cartella isolata "hello"
      - name: Bootstrap hello app
        run: |
          mkdir -p hello/electron hello/public
          cd hello
          cat > package.json << 'JSON'
          {
            "name": "lecuredesign-electron",
            "version": "0.0.1",
            "private": true,
            "main": "electron/main.js",
            "type": "module",
            "scripts": {
              "build:app": "electron-builder --mac dmg --arm64 -c.mac.identity=null -c.dmg.artifactName='LeCureDesign-${version}-mac-arm64.${ext}'"
            },
            "devDependencies": {
              "electron": "31.2.0",
              "electron-builder": "24.13.3"
            }
          }
          JSON

          cat > electron/main.js << 'JS'
          import { app, BrowserWindow } from 'electron'
          app.whenReady().then(() => {
            const win = new BrowserWindow({ width: 900, height: 600 })
            win.loadFile('public/index.html')
          })
          JS

          cat > public/index.html << 'HTML'
          <!doctype html><html><head>
            <meta charset="utf-8"/><title>LeCureDesign</title>
            <style>body{font:16px system-ui;margin:24px}h1{margin:0 0 8px}</style>
          </head><body>
            <h1>LeCureDesign Installer</h1>
            <p>âœ… Pipeline DMG ok. Puoi installare questa app sul Mac.</p>
          </body></html>
          HTML

      - name: Install deps
        run: cd hello && npm install --no-audit --no-fund

      - name: Build DMG (arm64)
        run: cd hello && npm run build:app

      - name: List dist
        run: ls -la hello/dist || true

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: LeCureDesign-DMG
          path: hello/dist/*.dmg

      # === NEW: crea e pusha un tag (v<run_number>) ===
      - name: Create & push tag
        run: |
          TAG="v${GITHUB_RUN_NUMBER}"
          echo "TAG=$TAG" >> $GITHUB_ENV
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Auto tag $TAG"
          git push origin "$TAG"

      # Usa il tag creato per pubblicare il Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: "LeCureDesign ${{ env.TAG }}"
          files: hello/dist/*.dmg
          generate_release_notes: true
