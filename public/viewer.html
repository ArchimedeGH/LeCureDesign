<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LeCureDesign — 3D Viewer</title>
  <style>
    html, body { margin:0; height:100%; }
    #app { width:100vw; height:100vh; overflow:hidden; background:#fafafa; }
    .hud { position:fixed; top:8px; left:8px; padding:6px 8px; background:#fff; border:1px solid #eee; border-radius:8px; font:14px system-ui,-apple-system, Segoe UI, Roboto, Helvetica, Arial; color:#333; }
  </style>
</head>
<body>
  <div id="app"></div>
  <div class="hud">Drag = orbit • Wheel = zoom • Shift+Drag = pan</div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.154.0/build/three.module.js'
    import { OrbitControls } from 'https://unpkg.com/three@0.154.0/examples/jsm/controls/OrbitControls.js'

    const proposals = JSON.parse(localStorage.getItem('skp_proposals') || '[]')
    const proposal = proposals[0] || { cabinets: [] }

    const app = document.getElementById('app')
    const renderer = new THREE.WebGLRenderer({ antialias: true })
    renderer.setSize(app.clientWidth, app.clientHeight)
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2))
    renderer.shadowMap.enabled = true
    renderer.shadowMap.type = THREE.PCFSoftShadowMap
    renderer.toneMapping = THREE.ACESFilmicToneMapping
    renderer.outputColorSpace = THREE.SRGBColorSpace
    app.appendChild(renderer.domElement)

    const scene = new THREE.Scene()
    scene.background = new THREE.Color('#fafafa')

    const camera = new THREE.PerspectiveCamera(50, app.clientWidth/app.clientHeight, 0.01, 100)
    camera.position.set(2.6, 1.8, 2.6)

    const controls = new OrbitControls(camera, renderer.domElement)
    controls.target.set(1.5, 0.8, 0.3)
    controls.update()

    scene.add(new THREE.AmbientLight(0xffffff, 0.35))
    const dir = new THREE.DirectionalLight(0xffffff, 0.9)
    dir.position.set(3, 5, 3)
    dir.castShadow = true
    dir.shadow.radius = 4
    dir.shadow.mapSize.set(2048,2048)
    scene.add(dir)

    const floor = new THREE.Mesh(
      new THREE.PlaneGeometry(5, 5),
      new THREE.MeshStandardMaterial({ color:'#f0f0f0', roughness:0.95 })
    )
    floor.rotation.x = -Math.PI/2
    floor.receiveShadow = true
    scene.add(floor)

    const grid = new THREE.GridHelper(5, 50, 0xdddddd, 0xeeeeee)
    grid.position.y = 0.001
    scene.add(grid)

    const matWhite = new THREE.MeshStandardMaterial({ color:'#f5f5f5', roughness:0.8 })
    const matOak   = new THREE.MeshStandardMaterial({ color:'#d9c3a1', roughness:0.6, metalness:0.1 })

    function addBox(w_cm, d_cm, h_cm, x_cm, y_cm, z_cm, oak=false) {
      const mesh = new THREE.Mesh(
        new THREE.BoxGeometry(w_cm/100, h_cm/100, d_cm/100),
        oak ? matOak : matWhite
      )
      mesh.position.set(x_cm/100, y_cm/100, z_cm/100)
      mesh.castShadow = mesh.receiveShadow = true
      scene.add(mesh)
      return mesh
    }

    const frontZ = 30 // cm
    let totalBaseW = 0

    for (const c of proposal.cabinets || []) {
      const isTall = c.kind === 'tall'
      const h_cm = isTall ? 210 : 75
      const y_cm = h_cm / 2
      const x_center = c.x_cm + c.w_cm/2
      addBox(c.w_cm, c.d_cm ?? 63, h_cm, x_center, y_cm, frontZ, false)
      if (!isTall) totalBaseW += c.w_cm
    }

    if (totalBaseW > 0) {
      const topH = 4 // cm
      addBox(totalBaseW, 63, topH, totalBaseW/2, 75 + topH/100, frontZ, true)
    }

    addEventListener('resize', () => {
      renderer.setSize(app.clientWidth, app.clientHeight)
      camera.aspect = app.clientWidth/app.clientHeight
      camera.updateProjectionMatrix()
    })

    const tick = () => { renderer.render(scene, camera); requestAnimationFrame(tick) }
    tick()
  </script>
</body>
</html>
